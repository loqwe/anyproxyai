name: Build All Platforms

on:
  push:
    branches:
      - main
      - master
    tags:
      - 'v*'
  pull_request:
    branches:
      - main
      - master
  workflow_dispatch:

# 添加写入权限以允许创建标签和发布
permissions:
  contents: write

jobs:
  # 检查是否需要构建
  check-build:
    runs-on: ubuntu-latest
    outputs:
      should_build: ${{ steps.check.outputs.should_build }}
      should_release: ${{ steps.check.outputs.should_release }}
      release_tag: ${{ steps.check.outputs.release_tag }}
      release_body: ${{ steps.check.outputs.release_body }}
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: Check commit message for build triggers
        id: check
        env:
          COMMIT_MSG: ${{ github.event.head_commit.message }}
        run: |
          # 只取第一行作为提交标题
          COMMIT_TITLE=$(echo "$COMMIT_MSG" | head -n 1)
          echo "Commit title: $COMMIT_TITLE"
          
          # 默认值
          SHOULD_BUILD="false"
          SHOULD_RELEASE="false"
          RELEASE_TAG=""
          RELEASE_BODY=""
          
          # 检查是否是 tag 推送
          if [[ "${{ github.ref }}" == refs/tags/v* ]]; then
            SHOULD_BUILD="true"
            SHOULD_RELEASE="true"
            RELEASE_TAG="${{ github.ref_name }}"
            RELEASE_BODY="Release ${RELEASE_TAG}"
          # 检查 tag(xxx): message 格式 - 使用 grep 和 sed 代替 bash 正则
          elif echo "$COMMIT_TITLE" | grep -qE '^tag\([^)]+\):'; then
            SHOULD_BUILD="true"
            SHOULD_RELEASE="true"
            # 提取 tag 版本号
            RELEASE_TAG=$(echo "$COMMIT_TITLE" | sed -E 's/^tag\(([^)]+)\):.*/\1/')
            # 提取描述信息
            RELEASE_BODY=$(echo "$COMMIT_TITLE" | sed -E 's/^tag\([^)]+\):[[:space:]]*//')
          # 检查 package( 开头
          elif echo "$COMMIT_TITLE" | grep -qE '^package\('; then
            SHOULD_BUILD="true"
          # 检查是否是 workflow_dispatch 或 PR
          elif [[ "${{ github.event_name }}" == "workflow_dispatch" ]] || [[ "${{ github.event_name }}" == "pull_request" ]]; then
            SHOULD_BUILD="true"
          fi
          
          echo "should_build=$SHOULD_BUILD" >> $GITHUB_OUTPUT
          echo "should_release=$SHOULD_RELEASE" >> $GITHUB_OUTPUT
          echo "release_tag=$RELEASE_TAG" >> $GITHUB_OUTPUT
          echo "release_body=$RELEASE_BODY" >> $GITHUB_OUTPUT
          
          echo "Should build: $SHOULD_BUILD"
          echo "Should release: $SHOULD_RELEASE"
          echo "Release tag: $RELEASE_TAG"
          echo "Release body: $RELEASE_BODY"

  build-windows:
    needs: check-build
    if: needs.check-build.outputs.should_build == 'true'
    runs-on: windows-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.22'
          cache: true
          cache-dependency-path: go.sum
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: frontend/package-lock.json
      
      - name: Install Wails
        run: go install github.com/wailsapp/wails/v2/cmd/wails@latest
      
      - name: Install frontend dependencies
        run: cd frontend && npm install
      
      - name: Build Windows amd64
        run: wails build -platform windows/amd64 -o anyproxyai-windows-amd64.exe
      
      - name: Build Windows arm64
        run: wails build -platform windows/arm64 -o anyproxyai-windows-arm64.exe
      
      - name: Upload Windows amd64 artifact
        uses: actions/upload-artifact@v4
        with:
          name: anyproxyai-windows-amd64
          path: build/bin/anyproxyai-windows-amd64.exe
      
      - name: Upload Windows arm64 artifact
        uses: actions/upload-artifact@v4
        with:
          name: anyproxyai-windows-arm64
          path: build/bin/anyproxyai-windows-arm64.exe

  build-linux-amd64:
    needs: check-build
    if: needs.check-build.outputs.should_build == 'true'
    runs-on: ubuntu-22.04
    steps:
      - uses: actions/checkout@v4
      
      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.22'
          cache: true
          cache-dependency-path: go.sum
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: frontend/package-lock.json
      
      - name: Install Linux dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y libgtk-3-dev libwebkit2gtk-4.0-dev
      
      - name: Install Wails
        run: go install github.com/wailsapp/wails/v2/cmd/wails@latest
      
      - name: Install frontend dependencies
        run: cd frontend && npm install
      
      - name: Build Linux amd64
        run: wails build -platform linux/amd64 -o anyproxyai-linux-amd64
      
      - name: Upload Linux amd64 artifact
        uses: actions/upload-artifact@v4
        with:
          name: anyproxyai-linux-amd64
          path: build/bin/anyproxyai-linux-amd64

  build-linux-arm64:
    needs: check-build
    if: needs.check-build.outputs.should_build == 'true'
    runs-on: ubuntu-22.04
    steps:
      - uses: actions/checkout@v4
      
      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.22'
          cache: true
          cache-dependency-path: go.sum
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: frontend/package-lock.json
      
      - name: Install cross-compile dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y gcc-aarch64-linux-gnu g++-aarch64-linux-gnu
          sudo dpkg --add-architecture arm64
          sudo sed -i 's/^deb /deb [arch=amd64] /' /etc/apt/sources.list
          echo "deb [arch=arm64] http://ports.ubuntu.com/ubuntu-ports jammy main restricted universe multiverse" | sudo tee -a /etc/apt/sources.list
          echo "deb [arch=arm64] http://ports.ubuntu.com/ubuntu-ports jammy-updates main restricted universe multiverse" | sudo tee -a /etc/apt/sources.list
          sudo apt-get update
          sudo apt-get install -y libgtk-3-dev:arm64 libwebkit2gtk-4.0-dev:arm64
      
      - name: Install Wails
        run: go install github.com/wailsapp/wails/v2/cmd/wails@latest
      
      - name: Install frontend dependencies
        run: cd frontend && npm install
      
      - name: Build Linux arm64
        run: |
          export CC=aarch64-linux-gnu-gcc
          export CXX=aarch64-linux-gnu-g++
          export CGO_ENABLED=1
          export GOOS=linux
          export GOARCH=arm64
          export PKG_CONFIG_PATH=/usr/lib/aarch64-linux-gnu/pkgconfig
          wails build -platform linux/arm64 -o anyproxyai-linux-arm64
      
      - name: Upload Linux arm64 artifact
        uses: actions/upload-artifact@v4
        with:
          name: anyproxyai-linux-arm64
          path: build/bin/anyproxyai-linux-arm64

  build-macos:
    needs: check-build
    if: needs.check-build.outputs.should_build == 'true'
    runs-on: macos-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.22'
          cache: true
          cache-dependency-path: go.sum
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: frontend/package-lock.json
      
      - name: Install Wails
        run: go install github.com/wailsapp/wails/v2/cmd/wails@latest
      
      - name: Install frontend dependencies
        run: cd frontend && npm install
      
      - name: Build macOS amd64
        run: wails build -platform darwin/amd64
      
      - name: Rename amd64 build
        run: mv build/bin/anyproxyai.app build/bin/anyproxyai-darwin-amd64.app
      
      - name: Build macOS arm64
        run: wails build -platform darwin/arm64
      
      - name: Rename arm64 build
        run: mv build/bin/anyproxyai.app build/bin/anyproxyai-darwin-arm64.app
      
      - name: Zip macOS apps
        run: |
          cd build/bin
          zip -r anyproxyai-darwin-amd64.zip anyproxyai-darwin-amd64.app
          zip -r anyproxyai-darwin-arm64.zip anyproxyai-darwin-arm64.app
      
      - name: Upload macOS amd64 artifact
        uses: actions/upload-artifact@v4
        with:
          name: anyproxyai-darwin-amd64
          path: build/bin/anyproxyai-darwin-amd64.zip
      
      - name: Upload macOS arm64 artifact
        uses: actions/upload-artifact@v4
        with:
          name: anyproxyai-darwin-arm64
          path: build/bin/anyproxyai-darwin-arm64.zip

  release:
    needs: [check-build, build-windows, build-linux-amd64, build-linux-arm64, build-macos]
    runs-on: ubuntu-latest
    if: needs.check-build.outputs.should_release == 'true'
    steps:
      - uses: actions/checkout@v4
      
      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts
      
      - name: Create and push tag (if from commit message)
        if: ${{ !startsWith(github.ref, 'refs/tags/') && needs.check-build.outputs.release_tag != '' }}
        run: |
          git config user.name github-actions
          git config user.email github-actions@github.com
          git tag ${{ needs.check-build.outputs.release_tag }}
          git push origin ${{ needs.check-build.outputs.release_tag }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ needs.check-build.outputs.release_tag || github.ref_name }}
          name: ${{ needs.check-build.outputs.release_tag || github.ref_name }}
          body: ${{ needs.check-build.outputs.release_body || format('Release {0}', github.ref_name) }}
          files: |
            artifacts/anyproxyai-windows-amd64/*
            artifacts/anyproxyai-windows-arm64/*
            artifacts/anyproxyai-linux-amd64/*
            artifacts/anyproxyai-linux-arm64/*
            artifacts/anyproxyai-darwin-amd64/*
            artifacts/anyproxyai-darwin-arm64/*
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
