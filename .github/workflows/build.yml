name: Build All Platforms

on:
  push:
    branches:
      - main
      - master
    tags:
      - 'v*'
  pull_request:
    branches:
      - main
      - master
  workflow_dispatch:

permissions:
  contents: write

jobs:
  check-build:
    runs-on: ubuntu-latest
    outputs:
      should_build: ${{ steps.check.outputs.should_build }}
      should_release: ${{ steps.check.outputs.should_release }}
      release_tag: ${{ steps.check.outputs.release_tag }}
      release_body: ${{ steps.check.outputs.release_body }}
    steps:
      - uses: actions/checkout@v4
      
      - name: Check commit message for build triggers
        id: check
        env:
          COMMIT_MSG: ${{ github.event.head_commit.message }}
        run: |
          COMMIT_TITLE=$(echo "$COMMIT_MSG" | head -n 1)
          echo "Commit title: $COMMIT_TITLE"
          
          SHOULD_BUILD="false"
          SHOULD_RELEASE="false"
          RELEASE_TAG=""
          RELEASE_BODY=""
          
          if [[ "${{ github.ref }}" == refs/tags/v* ]]; then
            SHOULD_BUILD="true"
            SHOULD_RELEASE="true"
            RELEASE_TAG="${{ github.ref_name }}"
            RELEASE_BODY="Release ${RELEASE_TAG}"
          elif echo "$COMMIT_TITLE" | grep -qE '^tag\([^)]+\):'; then
            SHOULD_BUILD="true"
            SHOULD_RELEASE="true"
            RELEASE_TAG=$(echo "$COMMIT_TITLE" | sed -E 's/^tag\(([^)]+)\):.*/\1/')
            RELEASE_BODY=$(echo "$COMMIT_TITLE" | sed -E 's/^tag\([^)]+\):[[:space:]]*//')
          elif echo "$COMMIT_TITLE" | grep -qE '^package\('; then
            SHOULD_BUILD="true"
          elif [[ "${{ github.event_name }}" == "workflow_dispatch" ]] || [[ "${{ github.event_name }}" == "pull_request" ]]; then
            SHOULD_BUILD="true"
          fi
          
          echo "should_build=$SHOULD_BUILD" >> $GITHUB_OUTPUT
          echo "should_release=$SHOULD_RELEASE" >> $GITHUB_OUTPUT
          echo "release_tag=$RELEASE_TAG" >> $GITHUB_OUTPUT
          echo "release_body=$RELEASE_BODY" >> $GITHUB_OUTPUT

  # Windows amd64 build (with icon)
  build-windows-amd64:
    needs: check-build
    if: needs.check-build.outputs.should_build == 'true'
    runs-on: windows-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.24'
          cache: true
          cache-dependency-path: go.sum
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22'
          cache: 'npm'
          cache-dependency-path: frontend/package-lock.json
      
      - name: Install frontend dependencies
        run: |
          cd frontend
          npm install
      
      - name: Build frontend
        run: |
          cd frontend
          npm run build
      
      - name: Install rsrc tool
        run: go install github.com/akavel/rsrc@latest
      
      - name: Generate Windows resources (icon + manifest)
        run: |
          rsrc -ico build\windows\icon.ico -manifest build\windows\anyproxyai.exe.manifest -o rsrc_windows_amd64.syso
      
      - name: Build Windows amd64
        env:
          GOOS: windows
          GOARCH: amd64
          CGO_ENABLED: 0
        run: |
          go build -ldflags "-s -w -H windowsgui" -o build\bin\anyproxyai-windows-amd64.exe .
      
      - name: Clean up syso
        run: |
          if (Test-Path "rsrc_windows_amd64.syso") { Remove-Item "rsrc_windows_amd64.syso" }
      
      - name: Upload Windows amd64 artifact
        uses: actions/upload-artifact@v4
        with:
          name: anyproxyai-windows-amd64
          path: build/bin/anyproxyai-windows-amd64.exe

  # Windows arm64 build (without icon - rsrc doesn't support arm64)
  build-windows-arm64:
    needs: check-build
    if: needs.check-build.outputs.should_build == 'true'
    runs-on: windows-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.24'
          cache: true
          cache-dependency-path: go.sum
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22'
          cache: 'npm'
          cache-dependency-path: frontend/package-lock.json
      
      - name: Install frontend dependencies
        run: |
          cd frontend
          npm install
      
      - name: Build frontend
        run: |
          cd frontend
          npm run build
      
      - name: Build Windows arm64
        env:
          GOOS: windows
          GOARCH: arm64
          CGO_ENABLED: 0
        run: |
          go build -ldflags "-s -w -H windowsgui" -o build\bin\anyproxyai-windows-arm64.exe .
      
      - name: Upload Windows arm64 artifact
        uses: actions/upload-artifact@v4
        with:
          name: anyproxyai-windows-arm64
          path: build/bin/anyproxyai-windows-arm64.exe

  # macOS builds (arm64 and amd64)
  build-macos:
    needs: check-build
    if: needs.check-build.outputs.should_build == 'true'
    runs-on: macos-latest
    strategy:
      matrix:
        arch: [arm64, amd64]
    steps:
      - uses: actions/checkout@v4
      
      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.24'
          cache: true
          cache-dependency-path: go.sum
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22'
          cache: 'npm'
          cache-dependency-path: frontend/package-lock.json
      
      - name: Install frontend dependencies
        run: cd frontend && npm install
      
      - name: Build frontend
        run: cd frontend && npm run build
      
      - name: Build macOS ${{ matrix.arch }}
        run: |
          export CGO_ENABLED=1
          export GOOS=darwin
          export GOARCH=${{ matrix.arch }}
          go build -ldflags "-s -w" -o build/bin/anyproxyai-darwin-${{ matrix.arch }} .
      
      - name: Create app bundle
        run: |
          mkdir -p build/bin/AnyProxyAi.app/Contents/MacOS
          mkdir -p build/bin/AnyProxyAi.app/Contents/Resources
          cp build/bin/anyproxyai-darwin-${{ matrix.arch }} build/bin/AnyProxyAi.app/Contents/MacOS/AnyProxyAi
          chmod +x build/bin/AnyProxyAi.app/Contents/MacOS/AnyProxyAi
          
          cat > build/bin/AnyProxyAi.app/Contents/Info.plist << 'EOF'
          <?xml version="1.0" encoding="UTF-8"?>
          <!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN" "http://www.apple.com/DTDs/PropertyList-1.0.dtd">
          <plist version="1.0">
          <dict>
              <key>CFBundleExecutable</key>
              <string>AnyProxyAi</string>
              <key>CFBundleIdentifier</key>
              <string>com.anyproxyai.app</string>
              <key>CFBundleName</key>
              <string>AnyProxyAi</string>
              <key>CFBundleDisplayName</key>
              <string>AnyProxyAi</string>
              <key>CFBundleVersion</key>
              <string>2.0.5</string>
              <key>CFBundleShortVersionString</key>
              <string>2.0.5</string>
              <key>CFBundlePackageType</key>
              <string>APPL</string>
              <key>LSMinimumSystemVersion</key>
              <string>10.15</string>
              <key>NSHighResolutionCapable</key>
              <true/>
          </dict>
          </plist>
          EOF
      
      - name: Zip macOS app
        run: |
          cd build/bin
          zip -r anyproxyai-darwin-${{ matrix.arch }}.zip AnyProxyAi.app
      
      - name: Upload macOS artifact
        uses: actions/upload-artifact@v4
        with:
          name: anyproxyai-darwin-${{ matrix.arch }}
          path: build/bin/anyproxyai-darwin-${{ matrix.arch }}.zip

  # Linux amd64 build
  build-linux-amd64:
    needs: check-build
    if: needs.check-build.outputs.should_build == 'true'
    runs-on: ubuntu-22.04
    steps:
      - uses: actions/checkout@v4
      
      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.24'
          cache: true
          cache-dependency-path: go.sum
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22'
          cache: 'npm'
          cache-dependency-path: frontend/package-lock.json
      
      - name: Install Linux dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y libgtk-3-dev libwebkit2gtk-4.1-dev
      
      - name: Install frontend dependencies
        run: cd frontend && npm install
      
      - name: Build frontend
        run: cd frontend && npm run build
      
      - name: Build Linux amd64
        run: |
          export CGO_ENABLED=1
          export GOOS=linux
          export GOARCH=amd64
          go build -ldflags "-s -w" -o build/bin/anyproxyai-linux-amd64 .
      
      - name: Upload Linux amd64 artifact
        uses: actions/upload-artifact@v4
        with:
          name: anyproxyai-linux-amd64
          path: build/bin/anyproxyai-linux-amd64

  # Linux arm64 build
  build-linux-arm64:
    needs: check-build
    if: needs.check-build.outputs.should_build == 'true'
    runs-on: ubuntu-22.04
    steps:
      - uses: actions/checkout@v4
      
      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.24'
          cache: true
          cache-dependency-path: go.sum
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22'
          cache: 'npm'
          cache-dependency-path: frontend/package-lock.json
      
      - name: Install cross-compilation dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y gcc-aarch64-linux-gnu
      
      - name: Install frontend dependencies
        run: cd frontend && npm install
      
      - name: Build frontend
        run: cd frontend && npm run build
      
      - name: Build Linux arm64
        run: |
          export CGO_ENABLED=1
          export GOOS=linux
          export GOARCH=arm64
          export CC=aarch64-linux-gnu-gcc
          go build -ldflags "-s -w" -o build/bin/anyproxyai-linux-arm64 .
      
      - name: Upload Linux arm64 artifact
        uses: actions/upload-artifact@v4
        with:
          name: anyproxyai-linux-arm64
          path: build/bin/anyproxyai-linux-arm64

  # Release job
  release:
    needs: [check-build, build-windows-amd64, build-windows-arm64, build-macos, build-linux-amd64, build-linux-arm64]
    runs-on: ubuntu-latest
    if: needs.check-build.outputs.should_release == 'true'
    steps:
      - uses: actions/checkout@v4
      
      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts
      
      - name: Display structure
        run: ls -R artifacts
      
      - name: Create and push tag (if from commit message)
        if: ${{ !startsWith(github.ref, 'refs/tags/') && needs.check-build.outputs.release_tag != '' }}
        continue-on-error: true
        run: |
          git config user.name github-actions
          git config user.email github-actions@github.com
          if git rev-parse "${{ needs.check-build.outputs.release_tag }}" >/dev/null 2>&1; then
            echo "Tag ${{ needs.check-build.outputs.release_tag }} already exists, skipping creation"
          else
            git tag ${{ needs.check-build.outputs.release_tag }}
            git push origin ${{ needs.check-build.outputs.release_tag }}
          fi
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ needs.check-build.outputs.release_tag || github.ref_name }}
          name: ${{ needs.check-build.outputs.release_tag || github.ref_name }}
          body: |
            ## ${{ needs.check-build.outputs.release_body || format('Release {0}', github.ref_name) }}
            
            ### 下载 / Downloads
            
            | 平台 Platform | 架构 Arch | 文件 File |
            |--------------|----------|-----------|
            | Windows | amd64 | anyproxyai-windows-amd64.exe |
            | Windows | arm64 | anyproxyai-windows-arm64.exe |
            | macOS | arm64 (Apple Silicon) | anyproxyai-darwin-arm64.zip |
            | macOS | amd64 (Intel) | anyproxyai-darwin-amd64.zip |
            | Linux | amd64 | anyproxyai-linux-amd64 |
            | Linux | arm64 | anyproxyai-linux-arm64 |
            
            > 注意: Windows arm64 版本不包含图标（rsrc 工具限制）
          files: |
            artifacts/anyproxyai-windows-amd64/*
            artifacts/anyproxyai-windows-arm64/*
            artifacts/anyproxyai-darwin-arm64/*
            artifacts/anyproxyai-darwin-amd64/*
            artifacts/anyproxyai-linux-amd64/*
            artifacts/anyproxyai-linux-arm64/*
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
